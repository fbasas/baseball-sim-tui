---
phase: 01-data-foundation-simulation-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/data/__init__.py
  - src/data/models.py
  - src/data/lahman.py
  - src/__init__.py
  - data/.gitkeep
  - requirements.txt
  - pyproject.toml
  - tests/__init__.py
  - tests/test_data_layer.py
autonomous: true

must_haves:
  truths:
    - "Repository loads any team roster from Lahman database by team_id and year"
    - "Repository returns player season statistics for batting and pitching"
    - "Missing data returns None or uses league average fallback"
    - "Database queries use parameterized SQL (no injection risk)"
  artifacts:
    - path: "src/data/models.py"
      provides: "PlayerSeason, BattingStats, PitchingStats, TeamSeason dataclasses"
      contains: "@dataclass"
    - path: "src/data/lahman.py"
      provides: "LahmanRepository class with query methods"
      exports: ["LahmanRepository"]
    - path: "requirements.txt"
      provides: "Python dependencies"
      contains: "numpy"
    - path: "tests/test_data_layer.py"
      provides: "Unit tests for repository"
      contains: "def test_"
  key_links:
    - from: "src/data/lahman.py"
      to: "sqlite3"
      via: "connection.execute"
      pattern: "self\\.conn\\.execute"
    - from: "src/data/lahman.py"
      to: "src/data/models.py"
      via: "returns dataclass instances"
      pattern: "(BattingStats|PitchingStats|PlayerSeason)"
---

<objective>
Set up Python project structure, data models, and Lahman database repository for loading historical player statistics.

Purpose: Establish the data access foundation that all simulation logic depends on. Without clean data loading, nothing else works.
Output: Working repository that can load any player's batting/pitching stats from any season.
</objective>

<execution_context>
@/home/fbasas/.claude/get-shit-done/workflows/execute-plan.md
@/home/fbasas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-data-foundation-simulation-core/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create project structure and dependencies</name>
  <files>
    - src/__init__.py
    - src/data/__init__.py
    - data/.gitkeep
    - tests/__init__.py
    - requirements.txt
    - pyproject.toml
  </files>
  <action>
Create the project directory structure following the architecture from RESEARCH.md:

```
src/
    __init__.py
    data/
        __init__.py
data/
    .gitkeep          # Placeholder for lahman.sqlite (user downloads)
tests/
    __init__.py
```

Create `requirements.txt` with:
```
numpy>=1.26.0
pytest>=8.0.0
```

Create `pyproject.toml` with:
```toml
[project]
name = "baseball-sim-tui"
version = "0.1.0"
description = "Terminal-based baseball simulation using historical player data"
requires-python = ">=3.11"

[tool.pytest.ini_options]
testpaths = ["tests"]
python_files = ["test_*.py"]
```

All `__init__.py` files should be empty (just comments noting the package purpose).
  </action>
  <verify>
Run `python -c "import src.data"` successfully.
Run `pip install -r requirements.txt` completes without errors.
  </verify>
  <done>Project structure exists, dependencies installable, package importable.</done>
</task>

<task type="auto">
  <name>Task 2: Create data models</name>
  <files>src/data/models.py</files>
  <action>
Create dataclasses for baseball statistics. Use Python's built-in `dataclasses` module (not Pydantic - keep dependencies minimal for Phase 1).

Required models:

1. `PlayerInfo` - Basic player identity from People table:
   - player_id: str (Lahman playerID)
   - name_first: str
   - name_last: str
   - bats: str ('R', 'L', 'B')
   - throws: str ('R', 'L')

2. `BattingStats` - Season batting statistics:
   - player_id: str
   - year: int
   - team_id: str
   - games: int
   - at_bats: int
   - runs: int
   - hits: int
   - doubles: int
   - triples: int
   - home_runs: int
   - rbi: int
   - stolen_bases: int
   - caught_stealing: int
   - walks: int
   - strikeouts: int
   - hit_by_pitch: int
   - sacrifice_flies: int
   - sacrifice_hits: int
   - gidp: int (ground into double play)
   - Add computed property `singles` = hits - doubles - triples - home_runs
   - Add computed property `plate_appearances` = at_bats + walks + hit_by_pitch + sacrifice_flies + sacrifice_hits

3. `PitchingStats` - Season pitching statistics:
   - player_id: str
   - year: int
   - team_id: str
   - games: int
   - games_started: int
   - wins: int
   - losses: int
   - ip_outs: int (innings pitched * 3)
   - hits_allowed: int
   - runs_allowed: int
   - earned_runs: int
   - home_runs_allowed: int
   - walks_allowed: int
   - strikeouts: int
   - hit_batters: int
   - batters_faced: int
   - wild_pitches: int
   - Add computed property `innings_pitched` = ip_outs / 3

4. `TeamSeason` - Team info for a season:
   - team_id: str
   - year: int
   - league_id: str
   - team_name: str
   - park_factor_batting: int (BPF from Teams table, default 100)
   - park_factor_pitching: int (PPF from Teams table, default 100)

All dataclasses should use `@dataclass` decorator. Handle None values gracefully (use `or 0` pattern for ints from database).
  </action>
  <verify>
Run `python -c "from src.data.models import BattingStats, PitchingStats, PlayerInfo, TeamSeason; print('Models OK')"` succeeds.
  </verify>
  <done>Four dataclass models defined with appropriate fields and computed properties.</done>
</task>

<task type="auto">
  <name>Task 3: Create Lahman repository</name>
  <files>
    - src/data/lahman.py
    - tests/test_data_layer.py
  </files>
  <action>
Create `LahmanRepository` class following the Repository pattern from RESEARCH.md.

Repository methods needed:

1. `__init__(self, db_path: str)` - Connect to SQLite database
   - Use `sqlite3.connect(db_path)`
   - Set `row_factory = sqlite3.Row` for dict-like access
   - Store connection as instance variable

2. `get_player_info(self, player_id: str) -> Optional[PlayerInfo]`
   - Query People table for player biographical info
   - Return None if not found

3. `get_batting_stats(self, player_id: str, year: int) -> Optional[BattingStats]`
   - Query Batting table for player's season stats
   - Handle multiple stints (player traded) by summing stats or taking first
   - Return None if no stats for that year
   - Handle NULL values from database (convert to 0)

4. `get_pitching_stats(self, player_id: str, year: int) -> Optional[PitchingStats]`
   - Query Pitching table for pitcher's season stats
   - Handle multiple stints similarly to batting
   - Return None if no stats for that year

5. `get_team_roster(self, team_id: str, year: int) -> List[PlayerInfo]`
   - Query for all players who appeared for team in that year
   - Join Batting (or Appearances if available) with People
   - Return list of PlayerInfo objects

6. `get_team_season(self, team_id: str, year: int) -> Optional[TeamSeason]`
   - Query Teams table for team info and park factors
   - Return None if team/year not found

7. `close(self)` - Close database connection

SQL notes:
- Lahman uses "2B", "3B" as column names (need quoting in SQL)
- Use parameterized queries: `cursor.execute("SELECT ... WHERE x = ?", (value,))`
- NULL handling: `row['AB'] or 0` pattern

Create tests in `tests/test_data_layer.py`:
- Test that repository can be instantiated (mock or skip if no db)
- Test that models serialize/deserialize correctly
- Test computed properties (singles, plate_appearances, innings_pitched)

Note: Tests should be skipped gracefully if lahman.sqlite doesn't exist (use pytest.skip).
  </action>
  <verify>
Run `python -c "from src.data.lahman import LahmanRepository; print('Repository OK')"` succeeds.
Run `pytest tests/test_data_layer.py -v` passes (with skips if no database).
  </verify>
  <done>Repository class can query Lahman database for players, batting stats, pitching stats, and team rosters. Tests pass.</done>
</task>

</tasks>

<verification>
1. `python -c "from src.data import models, lahman; print('Imports OK')"` - Modules importable
2. `pytest tests/ -v` - All tests pass (or skip gracefully without database)
3. Code review: No SQL string concatenation (all parameterized queries)
4. Code review: All dataclasses use type hints
</verification>

<success_criteria>
- Project structure matches architecture from RESEARCH.md
- Four data models defined with correct fields from Lahman schema
- Repository class implements all query methods
- Computed properties work correctly (singles, PA, IP)
- Tests exist and pass (with graceful skip if no database)
- No hardcoded database paths (path passed to constructor)
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-foundation-simulation-core/01-01-SUMMARY.md`
</output>
